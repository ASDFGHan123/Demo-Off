<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% if conversation.type == 'private' %}
            {% if conversation.privatechat.user1 == user %}
                {{ conversation.privatechat.user2.display_name }}
            {% else %}
                {{ conversation.privatechat.user1.display_name }}
            {% endif %}
        {% else %}
            {{ conversation.title|default:"Group Chat" }}
        {% endif %}
         - OffChat
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{% url 'chat_list' %}">OffChat</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{% url 'chat_list' %}">Back to Chats</a>
                <a class="nav-link" href="{% url 'logout' %}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <h2>
                    {% if conversation.type == 'private' %}
                        {% if conversation.privatechat.user1 == user %}
                            {{ conversation.privatechat.user2.display_name }}
                        {% else %}
                            {{ conversation.privatechat.user1.display_name }}
                        {% endif %}
                    {% else %}
                        {{ conversation.title|default:"Group Chat" }}
                    {% endif %}
                </h2>

                <div id="messages" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto;">
                    {% for message in messages %}
                        <div class="message mb-2 {% if message.sender == user %}text-end{% endif %}">
                            <div class="d-inline-block p-2 rounded {% if message.sender == user %}bg-primary text-white{% else %}bg-light{% endif %}">
                                <strong>{{ message.sender.display_name }}:</strong> {{ message.content }}
                                <small class="text-muted d-block">{{ message.sent_at|date:"M d, H:i" }}</small>
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted text-center">No messages yet. Start the conversation!</p>
                    {% endfor %}
                </div>

                <form id="message-form" method="post" action="{% url 'send_message' conversation.conversation_id %}">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" id="message-input" name="content" class="form-control" placeholder="Type your message..." required>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>

                <div id="response-message" class="mt-2" style="display: none;"></div>

                <!-- WebSocket connection -->
                <script>
                    const conversationId = "{{ conversation.conversation_id }}";
                    const currentUserId = "{{ user.user_id }}";
                    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = wsProtocol + '//' + '192.168.2.9:8000' + '/ws/chat/' + conversationId + '/';
                    const chatSocket = new WebSocket(wsUrl);

                    chatSocket.onopen = function(e) {
                        console.log('WebSocket connection established');
                        // Add connection status indicator
                        const statusDiv = document.createElement('div');
                        statusDiv.id = 'connection-status';
                        statusDiv.className = 'alert alert-success mt-2';
                        statusDiv.innerHTML = 'Connected to chat server';
                        const container = document.querySelector('.container');
                        container.insertBefore(statusDiv, container.firstChild.nextSibling);
                    };

                    chatSocket.onmessage = function(e) {
                        const data = JSON.parse(e.data);
                        console.log('Received message:', data);
                        if (data.message) {
                            // Add new message to the chat without refreshing
                            const messagesDiv = document.getElementById('messages');
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'message mb-2';
                            if (data.user_id == currentUserId) {
                                messageDiv.classList.add('text-end');
                            }
                            const bgClass = (data.user_id == currentUserId) ? 'bg-primary text-white' : 'bg-light';
                            messageDiv.innerHTML = '<div class="d-inline-block p-2 rounded ' + bgClass + '">' +
                                '<strong>' + data.user + ':</strong> ' + data.message +
                                '<small class="text-muted d-block">' + new Date(data.timestamp).toLocaleString() + '</small>' +
                                '</div>';
                            messagesDiv.appendChild(messageDiv);
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        } else if (data.type === 'user_status') {
                            console.log('User status update:', data);
                        } else if (data.type === 'reaction') {
                            console.log('Reaction update:', data);
                        } else if (data.type === 'notification') {
                            console.log('Notification:', data);
                        }
                    };

                    chatSocket.onclose = function(e) {
                        console.error('Chat socket closed unexpectedly');
                        // Update connection status
                        let statusDiv = document.getElementById('connection-status');
                        if (!statusDiv) {
                            statusDiv = document.createElement('div');
                            statusDiv.id = 'connection-status';
                            const container = document.querySelector('.container');
                            container.insertBefore(statusDiv, container.firstChild.nextSibling);
                        }
                        statusDiv.className = 'alert alert-danger mt-2';
                        statusDiv.innerHTML = 'Connection lost. Please refresh the page to reconnect.';
                        console.log('WebSocket connection lost. Please refresh the page to reconnect.');
                    };

                    chatSocket.onerror = function(e) {
                        console.error('WebSocket error:', e);
                    };

                    // Send message via WebSocket when form is submitted
                    let isSubmitting = false; // Prevent double submission

                    document.getElementById('message-form').addEventListener('submit', function(e) {
                        e.preventDefault();

                        if (isSubmitting) {
                            console.log('Already submitting, ignoring duplicate submission');
                            return;
                        }

                        const messageInput = document.getElementById('message-input');
                        const message = messageInput.value.trim();

                        if (message) {
                            isSubmitting = true;
                            const originalMessage = message; // Store the message

                            // Send via HTTP first for persistence
                            const formData = new FormData(this);
                            fetch(this.action, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                                }
                            }).then(response => {
                                if (response.ok) {
                                    console.log('Message sent successfully via HTTP');
                                } else {
                                    console.error('HTTP send failed:', response.status);
                                }
                            }).catch(error => {
                                console.error('HTTP send failed:', error);
                            }).finally(() => {
                                isSubmitting = false; // Reset submission flag
                            });

                            // Send via WebSocket if connected
                            if (chatSocket.readyState === WebSocket.OPEN) {
                                chatSocket.send(JSON.stringify({
                                    'message': originalMessage
                                }));
                                console.log('Message sent via WebSocket');
                                // Clear input immediately after WebSocket send
                                messageInput.value = '';
                            } else {
                                console.log('WebSocket not connected, cannot send message');
                                // Don't clear input if WebSocket is not connected
                                const statusDiv = document.getElementById('connection-status');
                                if (statusDiv) {
                                    statusDiv.className = 'alert alert-warning mt-2';
                                    statusDiv.innerHTML = 'Cannot send message - connection lost. Please refresh the page.';
                                }
                                isSubmitting = false;
                                return;
                            }
                        }
                    });
                </script>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Chat Info</h5>
                    </div>
                    <div class="card-body">
                        {% if conversation.type == 'group' %}
                            <p><strong>Title:</strong> {{ conversation.title }}</p>
                            <p><strong>Description:</strong> {{ conversation.groupchat.description|default:"No description" }}</p>
                            <p><strong>Members:</strong> {{ conversation.groupchat.groupmember_set.count }}</p>
                        {% else %}
                            <p><strong>Type:</strong> Private Chat</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-scroll to bottom of messages
        const messagesDiv = document.getElementById('messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Submit form on Enter key
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('message-form').submit();
            }
        });

    </script>
</body>
</html>